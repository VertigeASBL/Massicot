<h1><:massicot:massicoter:> [(#ENV{objet}|=={document}|?{Document #ENV{id_objet}, Logo #ENV{objet} #ENV{id_objet}})]</h1>

#FORMULAIRE_MASSICOTER_IMAGE{#OBJET, #ID_OBJET, #ENV{redirect}}

<div class="image-massicot">
  <BOUCLE_doc(DOCUMENTS) {si #OBJET|=={document}} {id_document = #ID_OBJET}>
    [(#FICHIER*|get_spip_doc|balise_img)]
  </BOUCLE_doc>
</div>

<script type="text/javascript">
 $(function () {

   var img = $('.image-massicot img'),
       imgAreaSelector,
       initialWidth=img.attr('width');

   /* Gestion du recadrage */
   function maj_formulaire (img, selection) {
     $('input[name=x1]').attr('value', selection.x1);
     $('input[name=x2]').attr('value', selection.x2);
     $('input[name=y1]').attr('value', selection.y1);
     $('input[name=y2]').attr('value', selection.y2);
   }

   /* Une fonction qui agrandi ou rapetisse l'image */
   function zoomer_image_massicot (valeur) {

     img
        .css('width', valeur * initialWidth + 'px')
        .css('height', 'auto')
        .css('margin-left', '-' + (Math.max((valeur*initialWidth - 780),0) / 2) + 'px' );

     /* On doit gérer le imgAreaSelector après avoir zoomé, sinon on
        peut avoir des valeurs de recadrage qui semblent trop grandes
        par rapport à l'image */
     if ( ! imgAreaSelector) {
       imgAreaSelector = img.imgAreaSelect({
         instance: true,
         handles: true,
         show: true,
         onSelectEnd: maj_formulaire,
         x1: $('input[name=x1]').attr('value'),
         x2: $('input[name=x2]').attr('value'),
         y1: $('input[name=y1]').attr('value'),
         y2: $('input[name=y2]').attr('value')
       });
     } else {
       imgAreaSelector.update();
     }
   }

   /* la valeur du zoom agit sur l'image */
   $('input#champ_zoom').change(function (e) {
     zoomer_image_massicot($(this).attr('value'));
   });

   /* initialiser le zoom */
   $('input#champ_zoom').trigger('change');

 });
</script>
